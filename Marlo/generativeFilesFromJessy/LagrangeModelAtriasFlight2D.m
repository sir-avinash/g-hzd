function [D,C,G,B,DampingSpringTorque,EL,ER]= LagrangeModelAtriasFlight2D(q,dq)
%%%%%%  LagrangeModelAtriasFlight2D.m
%%%%  01-Feb-2015 21:40:50
%%%%
%%%% Authors(s): Grizzle
%%%%
%%%%
%%%% Model NOTATION: Spong and Vidyasagar, page 142, Eq. (6.3.12)
%%%%                 D(q)ddq + C(q,dq)*dq + G(q) + DampingSpringTorque = B*tau + EL*GroundReactionForceLeft + ER*GroundReactionForceRight
%%%%
%%%%
[g mTotal L1 L2 L3 L4 m1 m2 m3 m4 Jcm1 Jcm2 Jcm3 Jcm4 ellzcm1 ...
         ellzcm2 ellzcm3 ellzcm4 ellycm1 ellycm2 ellycm3 ellycm4 LT mT ...
         JcmT ellzcmT ellycmT mH JcmH K1 K2 Kd1 Kd2 Jrotor1 Jrotor2 ...
         Jgear1  Jgear2 R1  R2] = modelParametersAtrias_v06;
%%%%
%%%%[g mTotal L1 L2 L3 L4 m1 m2 m3 m4 Jcm1 Jcm2 Jcm3 Jcm4 ellzcm1 ellzcm2 ellzcm3 ellzcm4 ellycm1 ellycm2 ellycm3 ellycm4 LT mT JcmT ellzcmT ellycmT mH JcmH K1 K2 Kd1 Kd2 Jrotor1 Jrotor2 Jgear1  Jgear2 R1  R2] = modelParametersAtrias_v05;
%%%%
%%%%
yH=q(1);  dyH=dq(1);
zH=q(2);  dzH=dq(2);
qT=q(3);  dqT=dq(3);
q1=q(4);  dq1=dq(4);
q2=q(5);  dq2=dq(5);
q1L=q(6);  dq1L=dq(6);
q2L=q(7);  dq2L=dq(7);
%%%%
%%%%
D=zeros(7,7)*q(1);
D(1,1)=2*m1 + 2*m2 + 2*m3 + 2*m4 + mH + mT;
D(1,3)=- (m1*(2*ellzcm1*cos(q1 + qT) + 2*ellycm1*...
         sin(q1 + qT)))/2 - (m2*(2*ellzcm2*cos(q2 + qT) + 2*ellycm2*...
         sin(q2 + qT)))/2 - (m1*(2*ellzcm1*cos(q1L + qT) + 2*ellycm1*...
         sin(q1L + qT)))/2 - (m2*(2*ellzcm2*cos(q2L + qT) + 2*ellycm2*...
         sin(q2L + qT)))/2 - (m3*(2*L1*cos(q1 + qT) + 2*ellzcm3*...
         cos(q2 + qT) + 2*ellycm3*sin(q2 + qT)))/2 - (m4*(2*L2*...
         cos(q2 + qT) + 2*ellzcm4*cos(q1 + qT) + 2*ellycm4*...
         sin(q1 + qT)))/2 - (m3*(2*L1*cos(q1L + qT) + 2*ellzcm3*...
         cos(q2L + qT) + 2*ellycm3*sin(q2L + qT)))/2 - (m4*(2*L2*...
         cos(q2L + qT) + 2*ellzcm4*cos(q1L + qT) + 2*ellycm4*...
         sin(q1L + qT)))/2 - (mT*(2*ellzcmT*cos(qT) + 2*ellycmT*...
         sin(qT)))/2;
D(1,4)=- (m1*(2*ellzcm1*cos(q1 + qT) + 2*ellycm1*...
         sin(q1 + qT)))/2 - (m4*(2*ellzcm4*cos(q1 + qT) + 2*ellycm4*...
         sin(q1 + qT)))/2 - L1*m3*cos(q1 + qT);
D(1,5)=- (m2*(2*ellzcm2*cos(q2 + qT) + 2*ellycm2*...
         sin(q2 + qT)))/2 - (m3*(2*ellzcm3*cos(q2 + qT) + 2*ellycm3*...
         sin(q2 + qT)))/2 - L2*m4*cos(q2 + qT);
D(1,6)=- (m1*(2*ellzcm1*cos(q1L + qT) + 2*ellycm1*...
         sin(q1L + qT)))/2 - (m4*(2*ellzcm4*cos(q1L + qT) + 2*ellycm4*...
         sin(q1L + qT)))/2 - L1*m3*cos(q1L + qT);
D(1,7)=- (m2*(2*ellzcm2*cos(q2L + qT) + 2*ellycm2*...
         sin(q2L + qT)))/2 - (m3*(2*ellzcm3*cos(q2L + qT) + 2*ellycm3*...
         sin(q2L + qT)))/2 - L2*m4*cos(q2L + qT);
D(2,2)=2*m1 + 2*m2 + 2*m3 + 2*m4 + mH + mT;
D(2,3)=(m1*(2*ellycm1*cos(q1 + qT) - 2*ellzcm1*...
         sin(q1 + qT)))/2 + (m2*(2*ellycm2*cos(q2 + qT) - 2*ellzcm2*...
         sin(q2 + qT)))/2 + (m1*(2*ellycm1*cos(q1L + qT) - 2*ellzcm1*...
         sin(q1L + qT)))/2 + (m2*(2*ellycm2*cos(q2L + qT) - 2*ellzcm2*...
         sin(q2L + qT)))/2 + (mT*(2*ellycmT*cos(qT) - 2*ellzcmT*...
         sin(qT)))/2 - (m3*(2*L1*sin(q1 + qT) - 2*ellycm3*...
         cos(q2 + qT) + 2*ellzcm3*sin(q2 + qT)))/2 - (m4*(2*L2*...
         sin(q2 + qT) - 2*ellycm4*cos(q1 + qT) + 2*ellzcm4*...
         sin(q1 + qT)))/2 - (m3*(2*L1*sin(q1L + qT) - 2*ellycm3*...
         cos(q2L + qT) + 2*ellzcm3*sin(q2L + qT)))/2 - (m4*(2*L2*...
         sin(q2L + qT) - 2*ellycm4*cos(q1L + qT) + 2*ellzcm4*...
         sin(q1L + qT)))/2;
D(2,4)=(m1*(2*ellycm1*cos(q1 + qT) - 2*ellzcm1*...
         sin(q1 + qT)))/2 + (m4*(2*ellycm4*cos(q1 + qT) - 2*ellzcm4*...
         sin(q1 + qT)))/2 - L1*m3*sin(q1 + qT);
D(2,5)=(m2*(2*ellycm2*cos(q2 + qT) - 2*ellzcm2*...
         sin(q2 + qT)))/2 + (m3*(2*ellycm3*cos(q2 + qT) - 2*ellzcm3*...
         sin(q2 + qT)))/2 - L2*m4*sin(q2 + qT);
D(2,6)=(m1*(2*ellycm1*cos(q1L + qT) - 2*ellzcm1*...
         sin(q1L + qT)))/2 + (m4*(2*ellycm4*cos(q1L + qT) - 2*ellzcm4*...
         sin(q1L + qT)))/2 - L1*m3*sin(q1L + qT);
D(2,7)=(m2*(2*ellycm2*cos(q2L + qT) - 2*ellzcm2*...
         sin(q2L + qT)))/2 + (m3*(2*ellycm3*cos(q2L + qT) - 2*ellzcm3*...
         sin(q2L + qT)))/2 - L2*m4*sin(q2L + qT);
D(3,1)=- (m1*(2*ellzcm1*cos(q1 + qT) + 2*ellycm1*...
         sin(q1 + qT)))/2 - (m2*(2*ellzcm2*cos(q2 + qT) + 2*ellycm2*...
         sin(q2 + qT)))/2 - (m1*(2*ellzcm1*cos(q1L + qT) + 2*ellycm1*...
         sin(q1L + qT)))/2 - (m2*(2*ellzcm2*cos(q2L + qT) + 2*ellycm2*...
         sin(q2L + qT)))/2 - (m3*(2*L1*cos(q1 + qT) + 2*ellzcm3*...
         cos(q2 + qT) + 2*ellycm3*sin(q2 + qT)))/2 - (m4*(2*L2*...
         cos(q2 + qT) + 2*ellzcm4*cos(q1 + qT) + 2*ellycm4*...
         sin(q1 + qT)))/2 - (m3*(2*L1*cos(q1L + qT) + 2*ellzcm3*...
         cos(q2L + qT) + 2*ellycm3*sin(q2L + qT)))/2 - (m4*(2*L2*...
         cos(q2L + qT) + 2*ellzcm4*cos(q1L + qT) + 2*ellycm4*...
         sin(q1L + qT)))/2 - (mT*(2*ellzcmT*cos(qT) + 2*ellycmT*...
         sin(qT)))/2;
D(3,2)=(m1*(2*ellycm1*cos(q1 + qT) - 2*ellzcm1*...
         sin(q1 + qT)))/2 + (m2*(2*ellycm2*cos(q2 + qT) - 2*ellzcm2*...
         sin(q2 + qT)))/2 + (m1*(2*ellycm1*cos(q1L + qT) - 2*ellzcm1*...
         sin(q1L + qT)))/2 + (m2*(2*ellycm2*cos(q2L + qT) - 2*ellzcm2*...
         sin(q2L + qT)))/2 + (mT*(2*ellycmT*cos(qT) - 2*ellzcmT*...
         sin(qT)))/2 - (m3*(2*L1*sin(q1 + qT) - 2*ellycm3*...
         cos(q2 + qT) + 2*ellzcm3*sin(q2 + qT)))/2 - (m4*(2*L2*...
         sin(q2 + qT) - 2*ellycm4*cos(q1 + qT) + 2*ellzcm4*...
         sin(q1 + qT)))/2 - (m3*(2*L1*sin(q1L + qT) - 2*ellycm3*...
         cos(q2L + qT) + 2*ellzcm3*sin(q2L + qT)))/2 - (m4*(2*L2*...
         sin(q2L + qT) - 2*ellycm4*cos(q1L + qT) + 2*ellzcm4*...
         sin(q1L + qT)))/2;
D(3,3)=2*Jcm1 + 2*Jcm2 + 2*Jcm3 + 2*Jcm4 + JcmH + JcmT + 2*...
         Jgear1 + 2*Jgear2 + 2*Jrotor1 + 2*Jrotor2 + 2*L1^2*m3 + 2*L2^2*...
         m4 + 2*ellycm1^2*m1 + 2*ellzcm1^2*m1 + 2*ellycm2^2*m2 + 2*...
         ellzcm2^2*m2 + 2*ellycm3^2*m3 + 2*ellzcm3^2*m3 + 2*ellycm4^2*...
         m4 + 2*ellzcm4^2*m4 + ellycmT^2*mT + ellzcmT^2*mT + 2*L1*ellzcm3*...
         m3*cos(q1 - q2) + 2*L2*ellzcm4*m4*cos(q1 - q2) + 2*L1*ellzcm3*m3*...
         cos(q1L - q2L) + 2*L2*ellzcm4*m4*cos(q1L - q2L) - 2*L1*ellycm3*...
         m3*sin(q1 - q2) + 2*L2*ellycm4*m4*sin(q1 - q2) - 2*L1*ellycm3*m3*...
         sin(q1L - q2L) + 2*L2*ellycm4*m4*sin(q1L - q2L);
D(3,4)=Jcm1 + Jcm4 + Jgear1 + L1^2*m3 + ellycm1^2*m1 + ellzcm1^2*...
         m1 + ellycm4^2*m4 + ellzcm4^2*m4 + Jrotor1*R1 + L1*ellzcm3*m3*...
         cos(q1 - q2) + L2*ellzcm4*m4*cos(q1 - q2) - L1*ellycm3*m3*...
         sin(q1 - q2) + L2*ellycm4*m4*sin(q1 - q2);
D(3,5)=Jcm2 + Jcm3 + Jgear2 + L2^2*m4 + ellycm2^2*m2 + ellzcm2^2*...
         m2 + ellycm3^2*m3 + ellzcm3^2*m3 + Jrotor2*R2 + L1*ellzcm3*m3*...
         cos(q1 - q2) + L2*ellzcm4*m4*cos(q1 - q2) - L1*ellycm3*m3*...
         sin(q1 - q2) + L2*ellycm4*m4*sin(q1 - q2);
D(3,6)=Jcm1 + Jcm4 + Jgear1 + L1^2*m3 + ellycm1^2*m1 + ellzcm1^2*...
         m1 + ellycm4^2*m4 + ellzcm4^2*m4 + Jrotor1*R1 + L1*ellzcm3*m3*...
         cos(q1L - q2L) + L2*ellzcm4*m4*cos(q1L - q2L) - L1*ellycm3*m3*...
         sin(q1L - q2L) + L2*ellycm4*m4*sin(q1L - q2L);
D(3,7)=Jcm2 + Jcm3 + Jgear2 + L2^2*m4 + ellycm2^2*m2 + ellzcm2^2*...
         m2 + ellycm3^2*m3 + ellzcm3^2*m3 + Jrotor2*R2 + L1*ellzcm3*m3*...
         cos(q1L - q2L) + L2*ellzcm4*m4*cos(q1L - q2L) - L1*ellycm3*m3*...
         sin(q1L - q2L) + L2*ellycm4*m4*sin(q1L - q2L);
D(4,1)=- (m1*(2*ellzcm1*cos(q1 + qT) + 2*ellycm1*...
         sin(q1 + qT)))/2 - (m4*(2*ellzcm4*cos(q1 + qT) + 2*ellycm4*...
         sin(q1 + qT)))/2 - L1*m3*cos(q1 + qT);
D(4,2)=(m1*(2*ellycm1*cos(q1 + qT) - 2*ellzcm1*...
         sin(q1 + qT)))/2 + (m4*(2*ellycm4*cos(q1 + qT) - 2*ellzcm4*...
         sin(q1 + qT)))/2 - L1*m3*sin(q1 + qT);
D(4,3)=Jcm1 + Jcm4 + Jgear1 + L1^2*m3 + ellycm1^2*m1 + ellzcm1^2*...
         m1 + ellycm4^2*m4 + ellzcm4^2*m4 + Jrotor1*R1 + L1*ellzcm3*m3*...
         cos(q1 - q2) + L2*ellzcm4*m4*cos(q1 - q2) - L1*ellycm3*m3*...
         sin(q1 - q2) + L2*ellycm4*m4*sin(q1 - q2);
D(4,4)=Jcm1 + Jcm4 + Jgear1 + Jrotor1*R1^2 + L1^2*m3 + ellycm1^2*...
         m1 + ellzcm1^2*m1 + ellycm4^2*m4 + ellzcm4^2*m4;
D(4,5)=L1*ellzcm3*m3*cos(q1 - q2) + L2*ellzcm4*m4*...
         cos(q1 - q2) - L1*ellycm3*m3*sin(q1 - q2) + L2*ellycm4*m4*...
         sin(q1 - q2);
D(5,1)=- (m2*(2*ellzcm2*cos(q2 + qT) + 2*ellycm2*...
         sin(q2 + qT)))/2 - (m3*(2*ellzcm3*cos(q2 + qT) + 2*ellycm3*...
         sin(q2 + qT)))/2 - L2*m4*cos(q2 + qT);
D(5,2)=(m2*(2*ellycm2*cos(q2 + qT) - 2*ellzcm2*...
         sin(q2 + qT)))/2 + (m3*(2*ellycm3*cos(q2 + qT) - 2*ellzcm3*...
         sin(q2 + qT)))/2 - L2*m4*sin(q2 + qT);
D(5,3)=Jcm2 + Jcm3 + Jgear2 + L2^2*m4 + ellycm2^2*m2 + ellzcm2^2*...
         m2 + ellycm3^2*m3 + ellzcm3^2*m3 + Jrotor2*R2 + L1*ellzcm3*m3*...
         cos(q1 - q2) + L2*ellzcm4*m4*cos(q1 - q2) - L1*ellycm3*m3*...
         sin(q1 - q2) + L2*ellycm4*m4*sin(q1 - q2);
D(5,4)=L1*ellzcm3*m3*cos(q1 - q2) + L2*ellzcm4*m4*...
         cos(q1 - q2) - L1*ellycm3*m3*sin(q1 - q2) + L2*ellycm4*m4*...
         sin(q1 - q2);
D(5,5)=Jcm2 + Jcm3 + Jgear2 + Jrotor2*R2^2 + L2^2*m4 + ellycm2^2*...
         m2 + ellzcm2^2*m2 + ellycm3^2*m3 + ellzcm3^2*m3;
D(6,1)=- (m1*(2*ellzcm1*cos(q1L + qT) + 2*ellycm1*...
         sin(q1L + qT)))/2 - (m4*(2*ellzcm4*cos(q1L + qT) + 2*ellycm4*...
         sin(q1L + qT)))/2 - L1*m3*cos(q1L + qT);
D(6,2)=(m1*(2*ellycm1*cos(q1L + qT) - 2*ellzcm1*...
         sin(q1L + qT)))/2 + (m4*(2*ellycm4*cos(q1L + qT) - 2*ellzcm4*...
         sin(q1L + qT)))/2 - L1*m3*sin(q1L + qT);
D(6,3)=Jcm1 + Jcm4 + Jgear1 + L1^2*m3 + ellycm1^2*m1 + ellzcm1^2*...
         m1 + ellycm4^2*m4 + ellzcm4^2*m4 + Jrotor1*R1 + L1*ellzcm3*m3*...
         cos(q1L - q2L) + L2*ellzcm4*m4*cos(q1L - q2L) - L1*ellycm3*m3*...
         sin(q1L - q2L) + L2*ellycm4*m4*sin(q1L - q2L);
D(6,6)=Jcm1 + Jcm4 + Jgear1 + Jrotor1*R1^2 + L1^2*m3 + ellycm1^2*...
         m1 + ellzcm1^2*m1 + ellycm4^2*m4 + ellzcm4^2*m4;
D(6,7)=L1*ellzcm3*m3*cos(q1L - q2L) + L2*ellzcm4*m4*...
         cos(q1L - q2L) - L1*ellycm3*m3*sin(q1L - q2L) + L2*ellycm4*m4*...
         sin(q1L - q2L);
D(7,1)=- (m2*(2*ellzcm2*cos(q2L + qT) + 2*ellycm2*...
         sin(q2L + qT)))/2 - (m3*(2*ellzcm3*cos(q2L + qT) + 2*ellycm3*...
         sin(q2L + qT)))/2 - L2*m4*cos(q2L + qT);
D(7,2)=(m2*(2*ellycm2*cos(q2L + qT) - 2*ellzcm2*...
         sin(q2L + qT)))/2 + (m3*(2*ellycm3*cos(q2L + qT) - 2*ellzcm3*...
         sin(q2L + qT)))/2 - L2*m4*sin(q2L + qT);
D(7,3)=Jcm2 + Jcm3 + Jgear2 + L2^2*m4 + ellycm2^2*m2 + ellzcm2^2*...
         m2 + ellycm3^2*m3 + ellzcm3^2*m3 + Jrotor2*R2 + L1*ellzcm3*m3*...
         cos(q1L - q2L) + L2*ellzcm4*m4*cos(q1L - q2L) - L1*ellycm3*m3*...
         sin(q1L - q2L) + L2*ellycm4*m4*sin(q1L - q2L);
D(7,6)=L1*ellzcm3*m3*cos(q1L - q2L) + L2*ellzcm4*m4*...
         cos(q1L - q2L) - L1*ellycm3*m3*sin(q1L - q2L) + L2*ellycm4*m4*...
         sin(q1L - q2L);
D(7,7)=Jcm2 + Jcm3 + Jgear2 + Jrotor2*R2^2 + L2^2*m4 + ellycm2^2*...
         m2 + ellzcm2^2*m2 + ellycm3^2*m3 + ellzcm3^2*m3;
%%%%
%%%%
%%%%
%%%%
C=zeros(7,7)*q(1);
C(1,3)=- dq1*((m1*(2*ellycm1*cos(q1 + qT) - 2*ellzcm1*...
         sin(q1 + qT)))/2 + (m4*(2*ellycm4*cos(q1 + qT) - 2*ellzcm4*...
         sin(q1 + qT)))/2 - L1*m3*sin(q1 + qT)) - dq2*((m2*(2*ellycm2*...
         cos(q2 + qT) - 2*ellzcm2*sin(q2 + qT)))/2 + (m3*(2*ellycm3*...
         cos(q2 + qT) - 2*ellzcm3*sin(q2 + qT)))/2 - L2*m4*...
         sin(q2 + qT)) - dq1L*((m1*(2*ellycm1*cos(q1L + qT) - 2*ellzcm1*...
         sin(q1L + qT)))/2 + (m4*(2*ellycm4*cos(q1L + qT) - 2*ellzcm4*...
         sin(q1L + qT)))/2 - L1*m3*sin(q1L + qT)) - dq2L*((m2*(2*ellycm2*...
         cos(q2L + qT) - 2*ellzcm2*sin(q2L + qT)))/2 + (m3*(2*ellycm3*...
         cos(q2L + qT) - 2*ellzcm3*sin(q2L + qT)))/2 - L2*m4*...
         sin(q2L + qT)) - dqT*((m1*(2*ellycm1*cos(q1 + qT) - 2*ellzcm1*...
         sin(q1 + qT)))/2 + (m2*(2*ellycm2*cos(q2 + qT) - 2*ellzcm2*...
         sin(q2 + qT)))/2 + (m1*(2*ellycm1*cos(q1L + qT) - 2*ellzcm1*...
         sin(q1L + qT)))/2 + (m2*(2*ellycm2*cos(q2L + qT) - 2*ellzcm2*...
         sin(q2L + qT)))/2 + (mT*(2*ellycmT*cos(qT) - 2*ellzcmT*...
         sin(qT)))/2 - (m3*(2*L1*sin(q1 + qT) - 2*ellycm3*...
         cos(q2 + qT) + 2*ellzcm3*sin(q2 + qT)))/2 - (m4*(2*L2*...
         sin(q2 + qT) - 2*ellycm4*cos(q1 + qT) + 2*ellzcm4*...
         sin(q1 + qT)))/2 - (m3*(2*L1*sin(q1L + qT) - 2*ellycm3*...
         cos(q2L + qT) + 2*ellzcm3*sin(q2L + qT)))/2 - (m4*(2*L2*...
         sin(q2L + qT) - 2*ellycm4*cos(q1L + qT) + 2*ellzcm4*...
         sin(q1L + qT)))/2);
C(1,4)=(dq1 + dqT)*(L1*m3*sin(q1 + qT) - ellycm1*m1*...
         cos(q1 + qT) - ellycm4*m4*cos(q1 + qT) + ellzcm1*m1*...
         sin(q1 + qT) + ellzcm4*m4*sin(q1 + qT));
C(1,5)=(dq2 + dqT)*(L2*m4*sin(q2 + qT) - ellycm2*m2*...
         cos(q2 + qT) - ellycm3*m3*cos(q2 + qT) + ellzcm2*m2*...
         sin(q2 + qT) + ellzcm3*m3*sin(q2 + qT));
C(1,6)=(dq1L + dqT)*(L1*m3*sin(q1L + qT) - ellycm1*m1*...
         cos(q1L + qT) - ellycm4*m4*cos(q1L + qT) + ellzcm1*m1*...
         sin(q1L + qT) + ellzcm4*m4*sin(q1L + qT));
C(1,7)=(dq2L + dqT)*(L2*m4*sin(q2L + qT) - ellycm2*m2*...
         cos(q2L + qT) - ellycm3*m3*cos(q2L + qT) + ellzcm2*m2*...
         sin(q2L + qT) + ellzcm3*m3*sin(q2L + qT));
C(2,3)=- dq1*((m1*(2*ellzcm1*cos(q1 + qT) + 2*ellycm1*...
         sin(q1 + qT)))/2 + (m4*(2*ellzcm4*cos(q1 + qT) + 2*ellycm4*...
         sin(q1 + qT)))/2 + L1*m3*cos(q1 + qT)) - dq2*((m2*(2*ellzcm2*...
         cos(q2 + qT) + 2*ellycm2*sin(q2 + qT)))/2 + (m3*(2*ellzcm3*...
         cos(q2 + qT) + 2*ellycm3*sin(q2 + qT)))/2 + L2*m4*...
         cos(q2 + qT)) - dq1L*((m1*(2*ellzcm1*cos(q1L + qT) + 2*ellycm1*...
         sin(q1L + qT)))/2 + (m4*(2*ellzcm4*cos(q1L + qT) + 2*ellycm4*...
         sin(q1L + qT)))/2 + L1*m3*cos(q1L + qT)) - dq2L*((m2*(2*ellzcm2*...
         cos(q2L + qT) + 2*ellycm2*sin(q2L + qT)))/2 + (m3*(2*ellzcm3*...
         cos(q2L + qT) + 2*ellycm3*sin(q2L + qT)))/2 + L2*m4*...
         cos(q2L + qT)) - dqT*((m1*(2*ellzcm1*cos(q1 + qT) + 2*ellycm1*...
         sin(q1 + qT)))/2 + (m2*(2*ellzcm2*cos(q2 + qT) + 2*ellycm2*...
         sin(q2 + qT)))/2 + (m1*(2*ellzcm1*cos(q1L + qT) + 2*ellycm1*...
         sin(q1L + qT)))/2 + (m2*(2*ellzcm2*cos(q2L + qT) + 2*ellycm2*...
         sin(q2L + qT)))/2 + (m3*(2*L1*cos(q1 + qT) + 2*ellzcm3*...
         cos(q2 + qT) + 2*ellycm3*sin(q2 + qT)))/2 + (m4*(2*L2*...
         cos(q2 + qT) + 2*ellzcm4*cos(q1 + qT) + 2*ellycm4*...
         sin(q1 + qT)))/2 + (m3*(2*L1*cos(q1L + qT) + 2*ellzcm3*...
         cos(q2L + qT) + 2*ellycm3*sin(q2L + qT)))/2 + (m4*(2*L2*...
         cos(q2L + qT) + 2*ellzcm4*cos(q1L + qT) + 2*ellycm4*...
         sin(q1L + qT)))/2 + (mT*(2*ellzcmT*cos(qT) + 2*ellycmT*...
         sin(qT)))/2);
C(2,4)=-(dq1 + dqT)*(L1*m3*cos(q1 + qT) + ellzcm1*m1*...
         cos(q1 + qT) + ellzcm4*m4*cos(q1 + qT) + ellycm1*m1*...
         sin(q1 + qT) + ellycm4*m4*sin(q1 + qT));
C(2,5)=-(dq2 + dqT)*(L2*m4*cos(q2 + qT) + ellzcm2*m2*...
         cos(q2 + qT) + ellzcm3*m3*cos(q2 + qT) + ellycm2*m2*...
         sin(q2 + qT) + ellycm3*m3*sin(q2 + qT));
C(2,6)=-(dq1L + dqT)*(L1*m3*cos(q1L + qT) + ellzcm1*m1*...
         cos(q1L + qT) + ellzcm4*m4*cos(q1L + qT) + ellycm1*m1*...
         sin(q1L + qT) + ellycm4*m4*sin(q1L + qT));
C(2,7)=-(dq2L + dqT)*(L2*m4*cos(q2L + qT) + ellzcm2*m2*...
         cos(q2L + qT) + ellzcm3*m3*cos(q2L + qT) + ellycm2*m2*...
         sin(q2L + qT) + ellycm3*m3*sin(q2L + qT));
C(3,3)=dq2*(L1*ellycm3*m3*cos(q1 - q2) - L2*ellycm4*m4*...
         cos(q1 - q2) + L1*ellzcm3*m3*sin(q1 - q2) + L2*ellzcm4*m4*...
         sin(q1 - q2)) - dq1*(L1*ellycm3*m3*cos(q1 - q2) - L2*ellycm4*m4*...
         cos(q1 - q2) + L1*ellzcm3*m3*sin(q1 - q2) + L2*ellzcm4*m4*...
         sin(q1 - q2)) - dq1L*(L1*ellycm3*m3*cos(q1L - q2L) - L2*ellycm4*...
         m4*cos(q1L - q2L) + L1*ellzcm3*m3*sin(q1L - q2L) + L2*ellzcm4*m4*...
         sin(q1L - q2L)) + dq2L*(L1*ellycm3*m3*cos(q1L - q2L) - L2*...
         ellycm4*m4*cos(q1L - q2L) + L1*ellzcm3*m3*sin(q1L - q2L) + L2*...
         ellzcm4*m4*sin(q1L - q2L));
C(3,4)=-(dq1 + dqT)*(L1*ellycm3*m3*cos(q1 - q2) - L2*ellycm4*m4*...
         cos(q1 - q2) + L1*ellzcm3*m3*sin(q1 - q2) + L2*ellzcm4*m4*...
         sin(q1 - q2));
C(3,5)=(dq2 + dqT)*(L1*ellycm3*m3*cos(q1 - q2) - L2*ellycm4*m4*...
         cos(q1 - q2) + L1*ellzcm3*m3*sin(q1 - q2) + L2*ellzcm4*m4*...
         sin(q1 - q2));
C(3,6)=-(dq1L + dqT)*(L1*ellycm3*m3*cos(q1L - q2L) - L2*ellycm4*...
         m4*cos(q1L - q2L) + L1*ellzcm3*m3*sin(q1L - q2L) + L2*ellzcm4*m4*...
         sin(q1L - q2L));
C(3,7)=(dq2L + dqT)*(L1*ellycm3*m3*cos(q1L - q2L) - L2*ellycm4*...
         m4*cos(q1L - q2L) + L1*ellzcm3*m3*sin(q1L - q2L) + L2*ellzcm4*m4*...
         sin(q1L - q2L));
C(4,3)=(dq2 + dqT)*(L1*ellycm3*m3*cos(q1 - q2) - L2*ellycm4*m4*...
         cos(q1 - q2) + L1*ellzcm3*m3*sin(q1 - q2) + L2*ellzcm4*m4*...
         sin(q1 - q2));
C(4,5)=(dq2 + dqT)*(L1*ellycm3*m3*cos(q1 - q2) - L2*ellycm4*m4*...
         cos(q1 - q2) + L1*ellzcm3*m3*sin(q1 - q2) + L2*ellzcm4*m4*...
         sin(q1 - q2));
C(5,3)=-(dq1 + dqT)*(L1*ellycm3*m3*cos(q1 - q2) - L2*ellycm4*m4*...
         cos(q1 - q2) + L1*ellzcm3*m3*sin(q1 - q2) + L2*ellzcm4*m4*...
         sin(q1 - q2));
C(5,4)=-(dq1 + dqT)*(L1*ellycm3*m3*cos(q1 - q2) - L2*ellycm4*m4*...
         cos(q1 - q2) + L1*ellzcm3*m3*sin(q1 - q2) + L2*ellzcm4*m4*...
         sin(q1 - q2));
C(6,3)=(dq2L + dqT)*(L1*ellycm3*m3*cos(q1L - q2L) - L2*ellycm4*...
         m4*cos(q1L - q2L) + L1*ellzcm3*m3*sin(q1L - q2L) + L2*ellzcm4*m4*...
         sin(q1L - q2L));
C(6,7)=(dq2L + dqT)*(L1*ellycm3*m3*cos(q1L - q2L) - L2*ellycm4*...
         m4*cos(q1L - q2L) + L1*ellzcm3*m3*sin(q1L - q2L) + L2*ellzcm4*m4*...
         sin(q1L - q2L));
C(7,3)=-(dq1L + dqT)*(L1*ellycm3*m3*cos(q1L - q2L) - L2*ellycm4*...
         m4*cos(q1L - q2L) + L1*ellzcm3*m3*sin(q1L - q2L) + L2*ellzcm4*m4*...
         sin(q1L - q2L));
C(7,6)=-(dq1L + dqT)*(L1*ellycm3*m3*cos(q1L - q2L) - L2*ellycm4*...
         m4*cos(q1L - q2L) + L1*ellzcm3*m3*sin(q1L - q2L) + L2*ellzcm4*m4*...
         sin(q1L - q2L));
%%%%
%%%%
%%%%
%%%%
G=zeros(7,1)*q(1);
G(1)=0;
G(2)=g*(2*m1 + 2*m2 + 2*m3 + 2*m4 + mH + mT);
G(3)=g*(m1*(ellycm1*cos(q1 + qT) - ellzcm1*sin(q1 + qT)) + m2*...
         (ellycm2*cos(q2 + qT) - ellzcm2*sin(q2 + qT)) + m1*(ellycm1*...
         cos(q1L + qT) - ellzcm1*sin(q1L + qT)) + m2*(ellycm2*...
         cos(q2L + qT) - ellzcm2*sin(q2L + qT)) + mT*(ellycmT*...
         cos(qT) - ellzcmT*sin(qT)) - m3*(L1*sin(q1 + qT) - ellycm3*...
         cos(q2 + qT) + ellzcm3*sin(q2 + qT)) - m4*(L2*...
         sin(q2 + qT) - ellycm4*cos(q1 + qT) + ellzcm4*sin(q1 + qT)) - m3*...
         (L1*sin(q1L + qT) - ellycm3*cos(q2L + qT) + ellzcm3*...
         sin(q2L + qT)) - m4*(L2*sin(q2L + qT) - ellycm4*...
         cos(q1L + qT) + ellzcm4*sin(q1L + qT)));
G(4)=g*(m1*(ellycm1*cos(q1 + qT) - ellzcm1*sin(q1 + qT)) + m4*...
         (ellycm4*cos(q1 + qT) - ellzcm4*sin(q1 + qT)) - L1*m3*...
         sin(q1 + qT));
G(5)=g*(m2*(ellycm2*cos(q2 + qT) - ellzcm2*sin(q2 + qT)) + m3*...
         (ellycm3*cos(q2 + qT) - ellzcm3*sin(q2 + qT)) - L2*m4*...
         sin(q2 + qT));
G(6)=g*(m1*(ellycm1*cos(q1L + qT) - ellzcm1*sin(q1L + qT)) + m4*...
         (ellycm4*cos(q1L + qT) - ellzcm4*sin(q1L + qT)) - L1*m3*...
         sin(q1L + qT));
G(7)=g*(m2*(ellycm2*cos(q2L + qT) - ellzcm2*sin(q2L + qT)) + m3*...
         (ellycm3*cos(q2L + qT) - ellzcm3*sin(q2L + qT)) - L2*m4*...
         sin(q2L + qT));
%%%%
%%%%
%%%%
%%%%
B=zeros(7,4)*q(1);
B(4,1)=R1;
B(5,2)=R2;
B(6,3)=R1;
B(7,4)=R2;
%%%%
%%%%
DampingSpringTorque=zeros(7,1)*q(1);
DampingSpringTorque(1)=0;
DampingSpringTorque(2)=0;
DampingSpringTorque(3)=0;
DampingSpringTorque(4)=0;
DampingSpringTorque(5)=0;
DampingSpringTorque(6)=0;
DampingSpringTorque(7)=0;
%%%%
%%%%
EL=zeros(7,2)*q(1);
EL(1,1)=1;
EL(2,2)=1;
EL(3,1)=- L2*cos(q2L + qT) - L4*cos(q1L + qT);
EL(3,2)=- L2*sin(q2L + qT) - L4*sin(q1L + qT);
EL(6,1)=-L4*cos(q1L + qT);
EL(6,2)=-L4*sin(q1L + qT);
EL(7,1)=-L2*cos(q2L + qT);
EL(7,2)=-L2*sin(q2L + qT);
%%%%
%%%%
ER=zeros(7,2)*q(1);
ER(1,1)=1;
ER(2,2)=1;
ER(3,1)=- L2*cos(q2 + qT) - L4*cos(q1 + qT);
ER(3,2)=- L2*sin(q2 + qT) - L4*sin(q1 + qT);
ER(4,1)=-L4*cos(q1 + qT);
ER(4,2)=-L4*sin(q1 + qT);
ER(5,1)=-L2*cos(q2 + qT);
ER(5,2)=-L2*sin(q2 + qT);
return